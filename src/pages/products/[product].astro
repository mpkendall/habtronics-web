---
import Layout from "../../layouts/Layout.astro";
import { getProductData, resolveStripeKey } from "../../lib/stripe";
const productDescriptions = import.meta.glob("../../content/*.{md,mdx}", {
  eager: true,
});

export const prerender = false;

const runtimeEnv = (Astro.locals as any)?.runtime?.env;
const stripeKey = resolveStripeKey(runtimeEnv);
const products = await getProductData(stripeKey);

const { product } = Astro.params;
const productData = products.find((p: any) => p.metadata.short === product);

const stock = Number(productData?.metadata?.stock);
console.log("Stock as number:", stock);
const productDesc = Object.values(productDescriptions).find(
  (p: any) => p.frontmatter.slug === product,
) as any;
---

<Layout class="!pb-0">
  <div
    id="product-page"
    class="-mt-20 grid grid-cols-[25%_75%] w-full min-h-screen"
  >
    <div
      id="showcase-section"
      class="bg-[#1B0C35] min-h-screen flex items-center flex-col"
    >
      <div id="content" class="sticky top-0 flex flex-col items-center w-[300px]">
        <div class="mt-[80px] mb-5 w-[300px] text-left">
          <a href="/shop" class="text-white font-sora text-lg hover-50">&lt; Back to Shop</a>
        </div>
        <img
          src={productData.image}
          class="w-[80%] object-cover rounded-2xl"
        />
        <p class="mt-5 text-white font-sora text-3xl">{productData.name}</p>
        <div class="flex flex-row items-center gap-10 mt-10">
          <button
            id="add-to-cart"
            class:list={[
              "font-sora text-lg w-35 h-10 rounded-xl",
              stock === 0
                ? "bg-gray-500 text-black cursor-not-allowed"
                : "bg-white text-black hover-50 cursor-pointer",
            ]}
            disabled={stock === 0}
          >
            {stock === 0 ? "Out of Stock" : "Add to Cart"}
          </button>
          <p class="font-sora text-xl text-white">${productData.price}</p>
        </div>
      </div>
    </div>
    <div id="product-info" class="ml-20 mr-20">
      <div class="mt-[100px] pb-15 font-inter text-xl prose prose-xl max-w-none prose-headings:font-sora prose-h1:text-3xl prose-h1:font-extrabold prose-h2:font-inter prose-h2:font-bold prose-h2:text-lg prose-p:font-inter prose-p:text-sm">
        <productDesc.Content />
      </div>
    </div>
    <div
      id="tag-data"
      data-title={productData.name}
      data-price={productData.price}
      data-price-id={productData.price_id}
    >
    </div>
  </div>

  <script>
    const addToCartButton = document.getElementById("add-to-cart");
    const dataDiv = document.getElementById("tag-data");

    if (!addToCartButton?.hasAttribute("disabled")) {
      addToCartButton?.addEventListener("click", () =>
        addToCart(
          dataDiv!.getAttribute("data-title")!,
          dataDiv!.getAttribute("data-price")!,
          dataDiv!.getAttribute("data-price-id")!,
        ),
      );
    }
    function addToCart(title: any, price: any, priceId: any) {
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const productIndex = cart.findIndex(
        (item: { priceId: any }) => item.priceId === priceId,
      );

      if (productIndex > -1) {
        cart[productIndex].quantity += 1;
      } else {
        const product = { title, price, priceId, quantity: 1 };
        cart.push(product);
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      alert(`${title} has been added to your cart!`);
    }
  </script>

</Layout>
