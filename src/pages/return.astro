---
export const prerender = false;
import Layout from "../layouts/Layout.astro";

const sessionID = Astro.url.searchParams.get("session_id");
if (!sessionID) return Astro.redirect('/shop');

import { resolveStripeKey } from '../lib/stripe';

let STRIPE_KEY: string;
try {
  const runtimeEnv = (Astro.locals as any)?.runtime?.env;
  STRIPE_KEY = resolveStripeKey(runtimeEnv);
} catch {
  return Astro.redirect('/shop');
}

const res = await fetch(`https://api.stripe.com/v1/checkout/sessions/${encodeURIComponent(sessionID)}`, {
  headers: { Authorization: `Bearer ${STRIPE_KEY}` },
});

if (!res.ok) {
  console.error('Failed to retrieve session:', await res.text());
  return Astro.redirect('/shop');
}

const session = await res.json();
const { name, email } = session.customer_details || { name: 'Customer', email: '' };
---

<Layout>
  <h1 class="font-sora text-3xl text-center">
    Thanks for your purchase, {name}!
  </h1>
  <p class="font-inter text-base text-center">
    We've sent a receipt to {email}.
  </p>
  <p class="font-inter text-base text-center mt-4">
    In the meantime, check out the <a href="https://github.com/New-England-Weather-Balloon-Society/Tiny4FSK" class="underline hover:text-blue-600">Github repository</a> for usage instructions!
  </p>
</Layout>

<script>
  localStorage.removeItem("cart");
</script>
